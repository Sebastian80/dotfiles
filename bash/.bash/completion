#!/usr/bin/env bash
# ~/.bash/completion
# Bash completion configuration
# Loaded by: .bash_profile and .bashrc

# ============================================
# Homebrew Bash Completion (v2)
# ============================================
# Load Homebrew-installed completions for tools like eza, bat, fd, rg, etc.
# This must be loaded BEFORE standard bash completion to ensure proper integration
if type brew &>/dev/null; then
    HOMEBREW_PREFIX="$(brew --prefix)"
    if [[ -r "${HOMEBREW_PREFIX}/etc/profile.d/bash_completion.sh" ]]; then
        source "${HOMEBREW_PREFIX}/etc/profile.d/bash_completion.sh"
    fi
fi

# ============================================
# Standard Bash Completion
# ============================================

# Enable programmable completion features
if ! shopt -oq posix; then
    if [ -f /usr/share/bash-completion/bash_completion ]; then
        source /usr/share/bash-completion/bash_completion
    elif [ -f /etc/bash_completion ]; then
        source /etc/bash_completion
    fi
fi

# ============================================
# Ubuntu Budgie VTE Integration
# ============================================
# Only load VTE integration in VTE-based terminals (Tilix, GNOME Terminal)
# Don't load in Ghostty to avoid conflicts
if [[ -z "$GHOSTTY_RESOURCES_DIR" ]]; then
    if [ "$TILIX_ID" ] || [ "$VTE_VERSION" ]; then
        [ -f /etc/profile.d/vte.sh ] && source /etc/profile.d/vte.sh
    fi
fi

# ============================================
# Git Completion Enhancements
# ============================================

# Enable tab completion for 'g' by marking it as an alias for 'git'
if type __git_complete &>/dev/null 2>&1; then
    __git_complete g __git_main
fi

# ============================================
# SSH Hostname Completion
# ============================================

# Add tab completion for SSH hostnames based on ~/.ssh/config
if [ -e "$HOME/.ssh/config" ]; then
    complete -o "default" -o "nospace" -W \
        "$(grep "^Host" ~/.ssh/config 2>/dev/null | \
        grep -v "[?*]" | \
        cut -d " " -f2- | \
        tr ' ' '\n')" \
        scp sftp ssh
fi

# ============================================
# Docker Completion (if Docker is installed)
# ============================================

if command -v docker &>/dev/null; then
    if [ -f /usr/share/bash-completion/completions/docker ]; then
        source /usr/share/bash-completion/completions/docker
    fi
fi

# ============================================
# kubectl Completion (if kubectl is installed)
# ============================================

if command -v kubectl &>/dev/null; then
    source <(kubectl completion bash 2>/dev/null)
    # Enable completion for 'k' alias if it exists
    complete -F __start_kubectl k 2>/dev/null
fi

# ============================================
# Cargo Completion (Rust)
# ============================================

if command -v rustup &>/dev/null; then
    if [ -f "$HOME/.cargo/env" ]; then
        # Cargo completions are usually installed with rustup
        if [ -f "$HOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/etc/bash_completion.d/cargo" ]; then
            source "$HOME/.rustup/toolchains/stable-x86_64-unknown-linux-gnu/etc/bash_completion.d/cargo"
        fi
    fi
fi

# ============================================
# npm Completion
# ============================================

if command -v npm &>/dev/null; then
    eval "$(npm completion 2>/dev/null)"
fi

# ============================================
# Custom Completions
# ============================================

# Completion for 'extract' function - suggest archive files
if declare -f extract &>/dev/null; then
    complete -f -X '!*.@(tar|tar.gz|tgz|tar.bz2|tbz2|tar.xz|txz|zip|rar|7z|gz|bz2|Z)' extract
fi

# Completion for common package managers
if command -v apt &>/dev/null; then
    complete -W "install remove update upgrade search show list" apt
fi

# ============================================
# Directory and File Completions
# ============================================

# Case-insensitive pathname matching for tab completion
bind "set completion-ignore-case on" 2>/dev/null

# Treat hyphens and underscores as equivalent
bind "set completion-map-case on" 2>/dev/null

# Display matches for ambiguous patterns at first tab press
bind "set show-all-if-ambiguous on" 2>/dev/null

# Immediately add a trailing slash when autocompleting symlinks to directories
bind "set mark-symlinked-directories on" 2>/dev/null

# Do not autocomplete hidden files unless the pattern explicitly begins with a dot
bind "set match-hidden-files off" 2>/dev/null

# Show all autocomplete results at once
bind "set page-completions off" 2>/dev/null

# If there are more than 200 possible completions, ask to show them all
bind "set completion-query-items 200" 2>/dev/null

# Show extra file information when completing, like `ls -F` does
bind "set visible-stats on" 2>/dev/null

# Be more intelligent when autocompleting by also looking at the text after
# the cursor. For example, when the current line is "cd ~/src/mozil", and
# the cursor is on the "z", pressing Tab will not autocomplete it to "cd
# ~/src/mozillail", but to "cd ~/src/mozilla". (This is supported by the
# Readline used by Bash 4.)
bind "set skip-completed-text on" 2>/dev/null

# Allow UTF-8 input and output
bind "set input-meta on" 2>/dev/null
bind "set output-meta on" 2>/dev/null
bind "set convert-meta off" 2>/dev/null

# Use Alt/Meta + Delete to delete the preceding word
bind '"\e[3;3~": kill-word' 2>/dev/null

# Colored completions (if supported)
bind "set colored-stats on" 2>/dev/null
bind "set colored-completion-prefix on" 2>/dev/null
