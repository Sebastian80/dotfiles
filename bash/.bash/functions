#!/usr/bin/env bash
# ~/.bash/functions
# Bash functions for all shells
# Loaded by: .bash_profile and .bashrc

# ============================================
# Directory & Navigation Functions
# ============================================

# Create directory and cd into it
mkd() {
    mkdir -p "$@" && cd "$_" || return
}

# Go up N directories
up() {
    local d=""
    local limit="${1:-1}"
    for ((i=1; i<=limit; i++)); do
        d="../$d"
    done
    cd "$d" || return
}

# ============================================
# File Operations
# ============================================

# Extract most known archives
extract() {
    if [ -f "$1" ]; then
        case "$1" in
            *.tar.bz2)   tar xjf "$1"     ;;
            *.tar.gz)    tar xzf "$1"     ;;
            *.tar.xz)    tar xJf "$1"     ;;
            *.bz2)       bunzip2 "$1"     ;;
            *.rar)       unrar e "$1"     ;;
            *.gz)        gunzip "$1"      ;;
            *.tar)       tar xf "$1"      ;;
            *.tbz2)      tar xjf "$1"     ;;
            *.tgz)       tar xzf "$1"     ;;
            *.zip)       unzip "$1"       ;;
            *.Z)         uncompress "$1"  ;;
            *.7z)        7z x "$1"        ;;
            *)           echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

# Create archive
archive() {
    if [ $# -lt 2 ]; then
        echo "Usage: archive <archive_name.ext> <files...>"
        return 1
    fi

    local archive_name="$1"
    shift

    case "$archive_name" in
        *.tar.gz)  tar czf "$archive_name" "$@" ;;
        *.tar.bz2) tar cjf "$archive_name" "$@" ;;
        *.tar.xz)  tar cJf "$archive_name" "$@" ;;
        *.zip)     zip -r "$archive_name" "$@" ;;
        *.7z)      7z a "$archive_name" "$@" ;;
        *)         echo "Unknown archive format: $archive_name" ;;
    esac
}

# Preview file with appropriate tool
preview() {
    local file="$1"
    if [ -z "$file" ]; then
        echo "Usage: preview <file>"
        return 1
    fi

    case "${file##*.}" in
        md|markdown)
            command -v glow &>/dev/null && glow "$file" || cat "$file"
            ;;
        jpg|jpeg|png|gif|bmp|webp)
            command -v viu &>/dev/null && viu "$file" || \
            command -v chafa &>/dev/null && chafa "$file" || \
            echo "No image viewer available"
            ;;
        json)
            command -v jq &>/dev/null && jq . "$file" || cat "$file"
            ;;
        *)
            if command -v bat &>/dev/null; then
                bat "$file"
            elif command -v batcat &>/dev/null; then
                batcat "$file"
            else
                cat "$file"
            fi
            ;;
    esac
}

# ============================================
# Search & Find Functions
# ============================================

# Find files by name (uses fd/fdfind if available, otherwise find)
ff() {
    if command -v fd &>/dev/null; then
        fd "$@"
    elif command -v fdfind &>/dev/null; then
        fdfind "$@"
    else
        find . -iname "*$@*" 2>/dev/null
    fi
}

# Search file contents (uses rg if available, otherwise grep)
search() {
    if command -v rg &>/dev/null; then
        rg "$@"
    else
        grep -r "$@" .
    fi
}

# Show largest files/directories
largest() {
    du -ah "${1:-.}" 2>/dev/null | sort -rh | head -n "${2:-20}"
}

# ============================================
# Git Functions
# ============================================

# Clone and cd into repository
clone() {
    if [ -z "$1" ]; then
        echo "Usage: clone <git_url>"
        return 1
    fi
    git clone "$@" && cd "$(basename "$1" .git)" || return
}

# Git commit with message
gcm() {
    if [ -z "$1" ]; then
        echo "Usage: gcm <commit_message>"
        return 1
    fi
    git commit -m "$@"
}

# Git add all and commit
gac() {
    if [ -z "$1" ]; then
        echo "Usage: gac <commit_message>"
        return 1
    fi
    git add -A && git commit -m "$@"
}

# ============================================
# System Information Functions
# ============================================

# Show disk usage in human-readable form
diskusage() {
    df -h | grep -v "tmpfs\|udev\|loop"
}

# Show memory usage
memusage() {
    free -h
    echo ""
    echo "Top 10 memory-consuming processes:"
    ps aux --sort=-%mem | head -n 11
}

# Show CPU usage
cpuusage() {
    top -b -n 1 | head -n 20
}

# ============================================
# Network Functions
# ============================================

# Get local IP address
localip() {
    hostname -I | awk '{print $1}'
}

# Get public IP address
publicip() {
    curl -s https://api.ipify.org && echo
}

# Test internet connection
testnet() {
    if ping -c 1 google.com &>/dev/null; then
        echo "✓ Internet connection is working"
    else
        echo "✗ No internet connection"
    fi
}

# ============================================
# Development Functions
# ============================================

# Create and activate Python virtual environment
venv() {
    if [ -d "venv" ]; then
        echo "Activating existing venv..."
        source venv/bin/activate
    else
        echo "Creating new venv..."
        python3 -m venv venv
        source venv/bin/activate
        echo "✓ Virtual environment created and activated"
    fi
}

# Start simple HTTP server
serve() {
    local port="${1:-8000}"
    if command -v python3 &>/dev/null; then
        echo "Starting HTTP server on port $port..."
        python3 -m http.server "$port"
    elif command -v python &>/dev/null; then
        echo "Starting HTTP server on port $port..."
        python -m SimpleHTTPServer "$port"
    else
        echo "Python not found"
        return 1
    fi
}

# ============================================
# Utility Functions
# ============================================

# Quick calculator
calc() {
    echo "$*" | bc -l
}

# Generate random password
genpass() {
    local length="${1:-16}"
    if command -v openssl &>/dev/null; then
        openssl rand -base64 "$length" | tr -d "=+/" | cut -c1-"$length"
    else
        cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w "$length" | head -n 1
    fi
}

# Backup file/directory with timestamp
backup() {
    if [ -z "$1" ]; then
        echo "Usage: backup <file_or_directory>"
        return 1
    fi
    local timestamp=$(date +%Y%m%d_%H%M%S)
    cp -r "$1" "${1}.backup.${timestamp}"
    echo "✓ Backup created: ${1}.backup.${timestamp}"
}

# Create timestamped note file
note() {
    local notedir="$HOME/notes"
    mkdir -p "$notedir"
    local notefile="$notedir/$(date +%Y-%m-%d).md"

    if [ -n "$1" ]; then
        echo "$(date +%H:%M:%S) - $*" >> "$notefile"
    else
        ${EDITOR:-micro} "$notefile"
    fi
}

# Weather forecast
weather() {
    local location="${1:-}"
    curl -s "wttr.in/${location}?format=3"
}
