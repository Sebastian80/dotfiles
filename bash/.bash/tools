#!/usr/bin/env bash
# ~/.bash/tools
# Terminal enhancement tool integrations
# Loaded by: .bash_profile and .bashrc

# ============================================
# fzf - Fuzzy Finder
# ============================================
if command -v fzf &>/dev/null; then
    # Load fzf bash integration (key bindings and completion)
    # This sources ~/.fzf.bash which runs: eval "$(fzf --bash)"
    # Provides Ctrl+R (history), Ctrl+T (files), Alt+C (directories)
    [ -f ~/.fzf.bash ] && source ~/.fzf.bash

    # fzf helper functions
    # Find and edit file
    fe() {
        local file
        file=$(fzf --query="$1" --select-1 --exit-0)
        [ -n "$file" ] && ${EDITOR:-micro} "$file"
    }

    # Find and cd into directory
    fcd() {
        local dir
        if command -v fd &>/dev/null; then
            dir=$(fd --type d "${1:-.}" | fzf +m)
        elif command -v fdfind &>/dev/null; then
            dir=$(fdfind --type d "${1:-.}" | fzf +m)
        else
            dir=$(find "${1:-.}" -type d 2>/dev/null | fzf +m)
        fi
        [ -n "$dir" ] && cd "$dir" || return
    }

    # Quick file search and preview
    fsearch() {
        if command -v fzf &>/dev/null; then
            local file
            file=$(fzf --query="$1" --preview 'preview {}')
            [ -n "$file" ] && preview "$file"
        else
            echo "fzf not installed"
        fi
    }
fi

# ============================================
# zoxide - Smart cd Command
# ============================================
if command -v zoxide &>/dev/null; then
    eval "$(zoxide init bash)"
    # Now you can use 'z' to jump to frequently used directories
    # Example: z projects, z downloads, etc.
fi

# ============================================
# yazi - Modern Terminal File Manager
# ============================================
if command -v yazi &>/dev/null; then
    # Shell wrapper function - changes directory on exit with 'q'
    # Press 'Q' (capital) to quit without changing directory
    function y() {
        local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
        yazi "$@" --cwd-file="$tmp"
        if IFS= read -r -d '' cwd < "$tmp" 2>/dev/null; then
            [ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
        fi
        rm -f -- "$tmp"
    }

    # Keybinding: Ctrl+O opens yazi (only in interactive shells)
    if [[ $- == *i* ]]; then
        bind -x '"\C-o": y' 2>/dev/null
    fi
fi

# ============================================
# direnv - Directory-specific Environment Variables
# ============================================
if command -v direnv &>/dev/null; then
    eval "$(direnv hook bash)"
fi

# ============================================
# starship - Cross-shell Prompt (Alternative to oh-my-posh)
# ============================================
# Disabled if oh-my-posh is being used
# if command -v starship &>/dev/null; then
#     eval "$(starship init bash)"
# fi

# ============================================
# asdf - Version Manager
# ============================================
if [ -f "$HOME/.asdf/asdf.sh" ]; then
    source "$HOME/.asdf/asdf.sh"
    [ -f "$HOME/.asdf/completions/asdf.bash" ] && source "$HOME/.asdf/completions/asdf.bash"
fi

# ============================================
# nvm - Node Version Manager (Alternative to fnm)
# ============================================
# Disabled if fnm is being used
# export NVM_DIR="$HOME/.nvm"
# [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
# [ -s "$NVM_DIR/bash_completion" ] && source "$NVM_DIR/bash_completion"

# ============================================
# Terminal Tools Help Function
# ============================================
terminal-tools-help() {
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Terminal Enhancement Tools - Quick Reference"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    echo "ğŸ“ File Viewing & Preview:"
    echo "  cat <file>         - View file with syntax highlighting (bat)"
    echo "  preview <file>     - Smart preview (auto-detects file type)"
    echo "  bat <file>         - Direct bat usage"
    echo ""

    echo "ğŸ“‚ File Listing:"
    echo "  ls                 - Modern ls with icons (eza)"
    echo "  ll                 - Long listing with git status"
    echo "  la                 - Show all files including hidden"
    echo "  lt                 - Tree view (2 levels)"
    echo "  lt3                - Tree view (3 levels)"
    echo ""

    echo "ğŸ—‚ï¸  File Management:"
    echo "  Ctrl+O             - Open yazi file manager (keybinding)"
    echo "  y, yy, or fm       - Open yazi (command)"
    echo "  fe [query]         - Find and edit file with fzf"
    echo "  fcd [dir]          - Change directory with fzf"
    echo "  z <dir>            - Jump to directory (zoxide)"
    echo "  zi                 - Interactive directory jump (zoxide)"
    echo ""

    echo "ğŸ” Search & Find:"
    echo "  rgg <pattern>      - Fast search with ripgrep"
    echo "  fd <name>          - Fast file find (fd)"
    echo "  ff <name>          - Universal file find (uses fd if available)"
    echo "  search <pattern>   - Universal search (uses rg if available)"
    echo "  fsearch [query]    - Search and preview files with fzf"
    echo "  Ctrl+R             - Search command history with fzf"
    echo "  Ctrl+T             - Find files with fzf"
    echo "  Alt+C              - Change directory with fzf"
    echo ""

    echo "ğŸ–¼ï¸  Image Viewing:"
    echo "  imgcat <file>      - View image in terminal (chafa)"
    echo "  imgview <file>     - View image in terminal (viu)"
    echo ""

    echo "ğŸ› ï¸  Utilities:"
    echo "  extract <file>     - Extract any archive format"
    echo "  archive <out> <in> - Create archive"
    echo "  mkd <dir>          - Create directory and cd into it"
    echo "  largest [dir]      - Show largest files"
    echo "  backup <file>      - Create timestamped backup"
    echo "  genpass [len]      - Generate random password"
    echo "  weather [loc]      - Show weather forecast"
    echo ""

    echo "ğŸ’» System Info:"
    echo "  diskusage          - Show disk usage"
    echo "  memusage           - Show memory usage"
    echo "  cpuusage           - Show CPU usage"
    echo "  localip            - Show local IP address"
    echo "  publicip           - Show public IP address"
    echo ""

    echo "ğŸ“¦ Development:"
    echo "  venv               - Create/activate Python virtual environment"
    echo "  serve [port]       - Start HTTP server (default: 8000)"
    echo "  clone <url>        - Clone repo and cd into it"
    echo ""

    echo "For more information on a specific tool, use: <tool> --help"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# ============================================
# Installed Tools Detection (for debugging)
# ============================================
show-tools() {
    echo "Installed Terminal Enhancement Tools:"
    echo "======================================"
    for tool in bat batcat eza fd fdfind fzf rg yazi zoxide chafa viu glow; do
        if command -v $tool &>/dev/null; then
            echo "  âœ“ $tool: $(command -v $tool)"
        else
            echo "  âœ— $tool: not installed"
        fi
    done
}
