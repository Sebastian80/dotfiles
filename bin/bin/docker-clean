#!/bin/bash
# docker-clean - Clean up Docker containers, images, volumes, and cache
# Usage: docker-clean [--all]

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

if ! command -v docker &> /dev/null; then
    error "Docker is not installed or not in PATH"
    exit 1
fi

ALL_MODE=false
if [[ "$1" == "--all" ]]; then
    ALL_MODE=true
    warn "Running in --all mode: will remove ALL images and volumes"
fi

echo "Docker Cleanup Utility"
echo "======================"
echo ""

# Show current disk usage
info "Current Docker disk usage:"
docker system df
echo ""

# Stop all running containers
RUNNING=$(docker ps -q | wc -l)
if [[ $RUNNING -gt 0 ]]; then
    warn "Stopping $RUNNING running container(s)..."
    docker stop $(docker ps -q) 2>/dev/null || true
fi

# Remove stopped containers
info "Removing stopped containers..."
docker container prune -f

# Remove dangling images
info "Removing dangling images..."
docker image prune -f

if [[ "$ALL_MODE" == true ]]; then
    # Remove ALL unused images
    info "Removing ALL unused images..."
    docker image prune -a -f

    # Remove unused volumes
    info "Removing unused volumes..."
    docker volume prune -f
fi

# Remove build cache
info "Removing build cache..."
docker builder prune -f

# Remove unused networks
info "Removing unused networks..."
docker network prune -f

echo ""
info "âœ“ Cleanup complete!"
echo ""
info "New Docker disk usage:"
docker system df
