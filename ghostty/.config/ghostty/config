# ========================================
# Ghostty Configuration for Oh My Posh
# ========================================
# Optimized for bash + Oh My Posh setup
# Reload config: Ctrl+Shift+R (or Ctrl+Shift+P > "Reload Config")
# Docs: https://ghostty.org/docs/config

# ========================================
# Theme & Colors
# ========================================
# Auto-switch between Catppuccin Frappe (dark) and Latte (light)
theme = dark:Catppuccin Frappe,light:Catppuccin Latte

# Alternative popular themes to try:
# theme = TokyoNight
# theme = Dracula
# theme = GitHub Dark Default
# theme = Nord
# theme = Catppuccin Mocha

# Auto-switch between dark/light (optional):
# theme = dark:Monokai Pro,light:Monokai Pro Light

# ========================================
# Font Configuration
# ========================================
# JetBrains Mono is built-in and has excellent Nerd Font support
# Perfect for Oh My Posh icons and powerline symbols
font-family = "JetBrains Mono"
font-size = 13
# font-thicken = true    # macOS only, no effect on Linux

# Enable font ligatures for better code readability
# Each font-feature must be on its own line
font-feature = +calt
font-feature = +liga

# Line height adjustment (pixels or percentage, e.g., 2 or 10%)
adjust-cell-height = 10%

# Alternative fonts (if installed):
# font-family = "Fira Code"
# font-family = "CascadiaCode Nerd Font"
# font-family = "Hack Nerd Font"

# ========================================
# Window Appearance
# ========================================
# Add padding for a cleaner look
window-padding-x = 10
window-padding-y = 10
window-padding-balance = true

# Transparency disabled - titlebar was too transparent and showing windows behind
# background-opacity = 0.92
# background-blur = true

# Window decoration - using default (not set like ttys3 config)
# window-decoration = client

# Window theme (titlebar color) - only works when gtk-adwaita is enabled (default)
# Disabled due to GTK parser errors
# Window theme - use Netresearch colors
window-theme = ghostty
window-titlebar-background = #1a1d21
window-titlebar-foreground = #9ca3af

# Window size (optional - comment out to use default)
# window-height = 35
# window-width = 120

# Save window state between sessions
# Disabled to prevent restoring smaller window size that causes prompt layout issues
window-save-state = never

# ========================================
# GTK Tab & Header Styling
# ========================================
# Custom CSS for compact tab styling (based on ttys3/my-ghostty-config)
# Added via PR: https://github.com/ghostty-org/ghostty/pull/4200
gtk-custom-css = tab-style.css

# Wide GNOME-style tabs for better readability
gtk-wide-tabs = true

# Tab position: top or bottom (left/right not supported in this GTK version)
gtk-tabs-location = top

# Tab bar visibility: always, auto, or never
window-show-tab-bar = auto

# Toolbar style: flat (no shadow) vs raised (with shadow)
gtk-toolbar-style = flat

# Optional: Disable titlebar to reduce height (uncomment to enable)
# This makes titlebar not too fat
# gtk-titlebar = false

# Merge tabs into titlebar for cleaner look
gtk-titlebar-style = tabs

# Optional: Disable all libadwaita features for even slimmer UI (uncomment to enable)
# WARNING: This will disable window-theme and other adwaita-related features
# gtk-adwaita = false

# ========================================
# Cursor
# ========================================
cursor-style = underline
cursor-style-blink = true
cursor-color = #2F99A4
cursor-opacity = 1.0

# ========================================
# Shell Integration
# ========================================
# Shell integration DISABLED - confirmed to conflict with oh-my-posh
# Even with our fixes, Ghostty's shell integration breaks:
# - Multiline prompt on resize (collapses to ">")
# - Title bar (shows "~" instead of folder name)
# We use simple-integration.bash instead for needed features
shell-integration = none

# ========================================
# Behavior & Security
# ========================================
# Don't confirm close when at a prompt
confirm-close-surface = false

# Prevent window title escape sequence injection (CVE-2024-56803)
title-report = false

# Scrollback buffer in lines (10k lines prevents HyperlinkMapOutOfMemory on resize)
# Large buffers with many hyperlinks (from Claude Code etc.) exhaust memory during resize
scrollback-limit = 10000

# Single instance mode - reuse process for new windows (faster, less RAM)
gtk-single-instance = true

# Proper emoji and international character widths
grapheme-width-method = unicode

# Bold text keeps its color instead of becoming bright
# (default behavior, bold-is-bright was deprecated in 1.2 → use bold-color = bright to enable)

# ========================================
# Performance
# ========================================
# GPU acceleration is always enabled in Ghostty

# New tabs/splits inherit current directory (also handled by OSC 7)
working-directory = inherit

# Enable clickable URLs
link-url = true

# ========================================
# Additional Customizations
# ========================================
# Uncomment and customize as needed:

# Custom window title
# title = "Terminal"

# Mouse behavior
mouse-hide-while-typing = true

# Increase trackpad scroll speed (default: precision:1,discrete:3)
# precision = trackpad scrolling, discrete = mouse wheel scrolling
mouse-scroll-multiplier = precision:5,discrete:3

# Clipboard & Selection
# Don't auto-copy selection to clipboard (use Ctrl+Shift+C instead)
copy-on-select = false

clipboard-read = ask
clipboard-write = allow
clipboard-trim-trailing-spaces = true
clipboard-paste-protection = true

# ========================================
# Custom Keybindings
# ========================================
# Reload config (Ctrl+Shift+R)
keybind = ctrl+shift+r=reload_config

# Command palette (Ghostty 1.2+) - popup with actions, keybindings, search
keybind = ctrl+shift+p=toggle_command_palette

# ========================================
# Bell / Sound Configuration
# ========================================
# Enable audio bell + visual indicators
# Options: audio, title, attention, border, system
bell-features = audio,title,attention

# Path to bell sound file (relative to this config or absolute)
# Uncomment and customize after placing your preferred sound file
# bell-audio = ~/.config/ghostty/bell.ogg

# Volume (0.0 to 1.0, default is 0.5)
bell-audio-volume = 0.3

# ========================================
# Keyboard Protocol Compatibility Fix
# ========================================
# Problem: Ghostty uses fixterms (CSI u sequences) by default
# Issue: fzf 0.66.0 does not support CSI u / Kitty keyboard protocol
# Result: Some key combinations show literal escape sequences (e.g., "109;5u")
#
# Solution: Override fixterms for common Ctrl combinations to use legacy encoding
# Trade-off: These keys will no longer be distinguishable from their equivalents
#   (e.g., Ctrl+I = Tab, Ctrl+M = Enter again)
#
# References:
# - fzf Issue #1980: https://github.com/junegunn/fzf/issues/1980
# - fzf Issue #3208: https://github.com/junegunn/fzf/issues/3208
# - Ghostty Discussion #5071: https://github.com/ghostty-org/ghostty/discussions/5071
# - fixterms spec: http://www.leonerd.org.uk/hacks/fixterms/
#
# Format: keybind = <trigger>=text:<hex_escape>

# Ctrl+[ → ESC (0x1B) instead of CSI 91;5u
keybind = ctrl+left_bracket=text:\x1b

# Ctrl+I → TAB (0x09) instead of CSI 105;5u
keybind = ctrl+i=text:\x09

# Ctrl+M → ENTER (0x0D) instead of CSI 109;5u
keybind = ctrl+m=text:\x0d

# Ctrl+J → LINEFEED (0x0A) instead of CSI 106;5u
keybind = ctrl+j=text:\x0a

# Ctrl+H → BACKSPACE (0x08) instead of CSI 104;5u
keybind = ctrl+h=text:\x08

# Additional common Ctrl combinations (expanded fix for bash compatibility)
# Many of these are printable ASCII control characters that bash expects
# Comments moved above keybinds to prevent them being included in the action

# Ctrl+A: SOH - Beginning of line / tmux prefix
keybind = ctrl+a=text:\x01
# Ctrl+B: STX - Backward char / tmux default prefix
keybind = ctrl+b=text:\x02
# Ctrl+C: ETX - Interrupt (SIGINT)
keybind = ctrl+c=text:\x03
# Ctrl+D: EOT - Delete char / EOF
keybind = ctrl+d=text:\x04
# Ctrl+E: ENQ - End of line
keybind = ctrl+e=text:\x05
# Ctrl+F: ACK - Forward char
keybind = ctrl+f=text:\x06
# Ctrl+G: BEL - Bell / abort
keybind = ctrl+g=text:\x07
# Ctrl+H already defined above (backspace)
# Ctrl+I already defined above (tab)
# Ctrl+J already defined above (linefeed)
# Ctrl+K: VT - Kill line
keybind = ctrl+k=text:\x0b
# Ctrl+L: FF - Clear screen
keybind = ctrl+l=text:\x0c
# Ctrl+M already defined above (return)
# Ctrl+N: SO - Next history
keybind = ctrl+n=text:\x0e
# Ctrl+O: SI - Operate-and-get-next
keybind = ctrl+o=text:\x0f
# Ctrl+P: DLE - Previous history
keybind = ctrl+p=text:\x10
# Ctrl+Q: DC1 - Resume (XON)
keybind = ctrl+q=text:\x11
# Ctrl+R: DC2 - Reverse search
keybind = ctrl+r=text:\x12
# Ctrl+S: DC3 - Suspend (XOFF)
keybind = ctrl+s=text:\x13
# Ctrl+T: DC4 - Transpose chars
keybind = ctrl+t=text:\x14
# Ctrl+U: NAK - Kill line backward
keybind = ctrl+u=text:\x15
# Ctrl+V: SYN - Literal next
keybind = ctrl+v=text:\x16
# Ctrl+W: ETB - Kill word backward
keybind = ctrl+w=text:\x17
# Ctrl+X: CAN - Prefix key
keybind = ctrl+x=text:\x18
# Ctrl+Y: EM - Yank
keybind = ctrl+y=text:\x19
# Ctrl+Z: SUB - Suspend (SIGTSTP)
keybind = ctrl+z=text:\x1a

# ========================================
# Cursor Movement (Word-wise)
# ========================================
# Ctrl+Left: Move cursor one word backward
keybind = ctrl+left=esc:b

# Ctrl+Right: Move cursor one word forward
keybind = ctrl+right=esc:f

# Alt+Left: Move cursor one word backward (alternative)
keybind = alt+left=esc:b

# Alt+Right: Move cursor one word forward (alternative)
keybind = alt+right=esc:f

# ========================================
# Word Deletion Keybinds
# ========================================
# Alt+Backspace: Delete word backward (Meta-Backspace = \x1b\x7f)
keybind = alt+backspace=text:\x1b\x7f

# Ctrl+Backspace: Delete word backward (same as Ctrl+W)
keybind = ctrl+backspace=text:\x17

# Alt+Delete: Delete word forward (Meta-Delete)
keybind = alt+delete=esc:[3;3~

# Ctrl+Delete: Delete word forward
keybind = ctrl+delete=esc:[3;5~

# ========================================
# Claude Code Compatibility
# ========================================
# Shift+Space: Just send regular space (not CSI u sequence)
keybind = shift+space=text:\x20

# Shift+Enter: Insert newline (Claude Code expects \n, not modifyOtherKeys sequence)
keybind = shift+enter=text:\n

# Ctrl+Enter: Same as Enter (Ghostty sends escape sequence by default)
keybind = ctrl+enter=text:\n

# Note: You can add more overrides as you discover problematic key combinations
# Format: keybind = ctrl+<key>=text:\x<hex_code>

# Close current pane/split (Ghostty-level, not tmux)
keybind = ctrl+shift+q=close_surface

# ========================================
# tmux Window Switching (Alt+1-9)
# ========================================
# Pass Alt+1-9 to tmux for window switching (when inside tmux)
# Ghostty tabs still work with Ctrl+Shift+T, Ctrl+Tab, etc.
keybind = alt+1=text:\x1b1
keybind = alt+2=text:\x1b2
keybind = alt+3=text:\x1b3
keybind = alt+4=text:\x1b4
keybind = alt+5=text:\x1b5
keybind = alt+6=text:\x1b6
keybind = alt+7=text:\x1b7
keybind = alt+8=text:\x1b8
keybind = alt+9=text:\x1b9

# ========================================
# German Keyboard Compatibility (Claude Code)
# ========================================
# Problem: Ctrl+international_characters (Ä, Ö, Ü, ß) have no legacy ASCII encoding
# Ghostty sends CSI u sequences like \x1b[196;5u for Ctrl+Ä (196 = Unicode of Ä)
# Claude Code doesn't understand these sequences and displays them literally
#
# Solution: Ignore these key combinations since they have no standard terminal meaning
# The CSI u format is: \x1b[<unicode_codepoint>;5u where 5 = ctrl modifier
#
# Unicode codepoints:
#   Ä = U+00C4 (196), ä = U+00E4 (228)
#   Ö = U+00D6 (214), ö = U+00F6 (246)
#   Ü = U+00DC (220), ü = U+00FC (252)
#   ß = U+00DF (223)

# Ctrl+Umlauts: Ignore (no legacy encoding exists)
# Ghostty accepts Unicode characters directly in keybinds
keybind = ctrl+ä=ignore
keybind = ctrl+shift+ä=ignore
keybind = ctrl+ö=ignore
keybind = ctrl+shift+ö=ignore
keybind = ctrl+ü=ignore
keybind = ctrl+shift+ü=ignore
keybind = ctrl+ß=ignore

# Alt+Ctrl+Umlauts: Also ignore to prevent CSI u sequences
keybind = ctrl+alt+ä=ignore
keybind = ctrl+alt+ö=ignore
keybind = ctrl+alt+ü=ignore
keybind = ctrl+alt+ß=ignore

# Ctrl+Punctuation: Ignore keys without legacy ASCII control codes
# Use Unicode characters directly (like umlauts above)
# ' (apostrophe) = U+0027 (39) → CSI 39;5u
# # (hash) = U+0023 (35) → CSI 35;5u
# + (plus) = U+002B (43) → CSI 43;5u
# < (less than) = U+003C (60) → CSI 60;5u
keybind = ctrl+'=ignore
keybind = ctrl+shift+'=ignore
keybind = ctrl+#=ignore
keybind = ctrl++=ignore
keybind = ctrl+<=ignore
keybind = ctrl+shift+<=ignore
